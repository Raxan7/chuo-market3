{% extends "jobs/base.html" %}
{% load static %}

{% block job_sidebar %}
<!-- Sidebar Filters -->
<div class="card mb-4">
  <div class="card-body">
    <form method="get" action="{% url 'jobs:job_list' %}" id="jobSearchForm">
      <div class="mb-3">
        <label class="form-label">Keywords</label>
        <div class="input-group">
          <span class="input-group-text"><i class="bi bi-search"></i></span>
          <input type="text" class="form-control" name="keywords" placeholder="Job title, skills, or keywords" value="{{ search_form.keywords.value|default:'' }}">
        </div>
      </div>
      <div class="mb-3">
        <label class="form-label">Location</label>
        <div class="input-group">
          <span class="input-group-text"><i class="bi bi-geo-alt"></i></span>
          <input type="text" class="form-control" name="location" placeholder="City or region" value="{{ search_form.location.value|default:'' }}">
        </div>
      </div>
      <div class="mb-3">
        <label class="form-label">Job Type</label>
        <select class="form-select" name="job_type">
          <option value="">All Job Types</option>
          {% for value, label in search_form.fields.job_type.choices %}
            <option value="{{ value }}" {% if value in search_form.job_type.value %}selected{% endif %}>{{ label }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="mb-3">
        <label class="form-label">Industry</label>
        <select class="form-select" name="industry">
          <option value="">All Industries</option>
          {% for industry in industries %}
            <option value="{{ industry.id }}" {% if search_form.industry.value == industry.id %}selected{% endif %}>{{ industry.name }} ({{ industry.job_count }})</option>
          {% endfor %}
        </select>
      </div>
      <div class="mb-3">
        <label class="form-label">Experience Level</label>
        <select class="form-select" name="experience_level">
          <option value="">Any Experience</option>
          {% for value, label in search_form.fields.experience_level.choices %}
            <option value="{{ value }}" {% if value in search_form.experience_level.value %}selected{% endif %}>{{ label }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="mb-3">
        <label class="form-label">Salary Range</label>
        <div class="input-group">
          <input type="number" class="form-control" name="salary_min" placeholder="Min" value="{{ search_form.salary_min.value|default:'' }}">
          <span class="input-group-text">TZS</span>
        </div>
      </div>
      <div class="mb-3">
        <label class="form-label">Date Posted</label>
        <select class="form-select" name="posted_since">
          <option value="">Any Time</option>
          {% for value, label in search_form.fields.posted_since.choices %}
            {% if value %}
              <option value="{{ value }}" {% if search_form.posted_since.value == value %}selected{% endif %}>{{ label }}</option>
            {% endif %}
          {% endfor %}
        </select>
      </div>
      <div class="mb-3">
        <label class="form-label">Job Options</label>
        <div class="d-flex flex-column gap-2">
          <div class="form-check">
            <input class="form-check-input" type="checkbox" name="remote_only" id="remoteOnly" {% if search_form.remote_only.value %}checked{% endif %}>
            <label class="form-check-label" for="remoteOnly">Remote jobs only</label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="checkbox" name="is_featured" id="featuredOnly" {% if search_form.is_featured.value %}checked{% endif %}>
            <label class="form-check-label" for="featuredOnly">Featured jobs only</label>
          </div>
        </div>
      </div>
      <div class="d-grid gap-2 mt-4">
        <a href="{% url 'jobs:job_list' %}" class="btn btn-outline-secondary">Clear Filters</a>
        <button type="submit" class="btn btn-primary">Apply Filters</button>
      </div>
    </form>
  </div>
</div>
{% endblock %}

{% block job_content %}
<!-- Jobs Found and Sorting -->
<div class="d-flex justify-content-between align-items-center mb-3">
    <div>
        <h4 class="mb-0">
            {% if search_form.keywords.value %}
            Search results for "{{ search_form.keywords.value }}"
            {% else %}
            Available Jobs
            {% endif %}
            <span class="badge bg-primary ms-2">{{ total_jobs|default:page_obj.paginator.count }}</span>
        </h4>
    </div>
    <div class="d-flex">
        <div class="dropdown me-2">
            <button class="btn btn-outline-secondary dropdown-toggle" type="button" id="sortDropdown" 
                data-bs-toggle="dropdown" aria-expanded="false">
                <i class="bi bi-sort-down"></i> Sort
            </button>
            <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="sortDropdown">
                <li>
                    <a class="dropdown-item {% if not request.GET.sort %}active{% endif %}" 
                        href="?{% for key, value in request.GET.items %}{% if key != 'sort' %}{{ key }}={{ value }}&{% endif %}{% endfor %}">
                        Newest First
                    </a>
                </li>
                <li>
                    <a class="dropdown-item {% if request.GET.sort == 'oldest' %}active{% endif %}" 
                        href="?{% for key, value in request.GET.items %}{% if key != 'sort' %}{{ key }}={{ value }}&{% endif %}{% endfor %}sort=oldest">
                        Oldest First
                    </a>
                </li>
                <li>
                    <a class="dropdown-item {% if request.GET.sort == 'salary_high' %}active{% endif %}" 
                        href="?{% for key, value in request.GET.items %}{% if key != 'sort' %}{{ key }}={{ value }}&{% endif %}{% endfor %}sort=salary_high">
                        Highest Salary
                    </a>
                </li>
                <li>
                    <a class="dropdown-item {% if request.GET.sort == 'most_applied' %}active{% endif %}" 
                        href="?{% for key, value in request.GET.items %}{% if key != 'sort' %}{{ key }}={{ value }}&{% endif %}{% endfor %}sort=most_applied">
                        Most Applied
                    </a>
                </li>
            </ul>
        </div>
        <div class="btn-group" role="group">
            <button type="button" class="btn btn-outline-secondary active" id="listViewBtn">
                <i class="bi bi-list"></i>
            </button>
            <button type="button" class="btn btn-outline-secondary" id="gridViewBtn">
                <i class="bi bi-grid"></i>
            </button>
        </div>
    </div>
</div>

<!-- Jobs List View -->
<div id="listView" class="job-view">
    <div class="card mb-4">
        <div class="card-body p-0">
            {% if page_obj.object_list %}
                {% for job in page_obj.object_list %}
                <div class="job-item p-3 border-bottom" data-source="{{ job.source|default:'internal' }}">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h5 class="mb-1">
                                <a href="{% url 'jobs:job_detail' job.id %}" class="text-decoration-none">
                                    {{ job.title }}
                                    {% if job.is_featured %}<span class="badge bg-warning text-dark ms-2">Featured</span>{% endif %}
                                    {% if job.posted_date|date:'Y-m-d' >= today|date:'Y-m-d' %}<span class="badge bg-success ms-2">New</span>{% endif %}
                                </a>
                            </h5>
                            <div class="mb-2">
                                <span class="text-muted">{{ job.company.name }}</span> • 
                                <span class="text-muted">{{ job.location }}</span>
                                {% if job.is_remote %}<span class="badge bg-success ms-1">Remote</span>{% endif %} •
                                <span class="badge bg-light text-dark">
                                    {{ job.get_job_type_display }}
                                </span>
                            </div>
                            <p class="mb-0 text-truncate-3">
                                {{ job.description|striptags|truncatewords:30 }}
                            </p>
                        </div>
                        {% if job.company.logo %}
                        <div class="ms-3">
                            <img src="{{ job.company.logo.url }}" alt="{{ job.company.name }}" 
                                class="company-logo" style="width: 60px; height: 60px; object-fit: contain;">
                        </div>
                        {% endif %}
                    </div>
                    <div class="d-flex justify-content-between align-items-center mt-3">
                        <div>
                            {% if job.salary_min %}
                            <span class="text-success">
                                TZS {{ job.salary_min|floatformat:0 }}
                                {% if job.salary_max %}
                                - {{ job.salary_max|floatformat:0 }}
                                {% endif %}
                            </span>
                            {% endif %}
                            
                            <small class="text-muted ms-3">Posted {{ job.posted_date|timesince }} ago</small>
                        </div>
                        <div>
                            {% if job.source != 'internal' %}
                            <span class="badge bg-secondary">{{ job.get_source_display }}</span>
                            {% endif %}
                            
                            {% if user.is_authenticated %}
                            <button class="btn btn-sm btn-outline-secondary ms-2 toggle-saved-job" 
                                data-job-id="{{ job.id }}" data-csrf="{{ csrf_token }}">
                                <i class="bi {% if job.is_saved %}bi-bookmark-fill{% else %}bi-bookmark{% endif %}"></i>
                            </button>
                            {% endif %}
                            
                            <a href="{% url 'jobs:job_detail' job.id %}" class="btn btn-sm btn-primary ms-2">View Details</a>
                        </div>
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <div class="p-5 text-center">
                    <div class="mb-4">
                        <i class="bi bi-search fs-1 text-muted"></i>
                    </div>
                    <h4>No jobs found</h4>
                    <p class="text-muted mb-4">We couldn't find any jobs matching your search criteria. Try adjusting your filters or search terms.</p>
                    <a href="{% url 'jobs:job_list' %}" class="btn btn-primary">View All Jobs</a>
                </div>
            {% endif %}
        </div>
    </div>
    
    <!-- Pagination -->
    {% if is_paginated %}
    <nav aria-label="Job pagination">
        <ul class="pagination justify-content-center">
            {% if page_obj.has_previous %}
            <li class="page-item">
                <a class="page-link" href="?page=1{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">
                    <i class="bi bi-chevron-double-left"></i>
                </a>
            </li>
            <li class="page-item">
                <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">
                    <i class="bi bi-chevron-left"></i>
                </a>
            </li>
            {% else %}
            <li class="page-item disabled">
                <span class="page-link"><i class="bi bi-chevron-double-left"></i></span>
            </li>
            <li class="page-item disabled">
                <span class="page-link"><i class="bi bi-chevron-left"></i></span>
            </li>
            {% endif %}
            
            {% for num in paginator.page_range %}
                {% if page_obj.number == num %}
                <li class="page-item active"><span class="page-link">{{ num }}</span></li>
                {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                <li class="page-item">
                    <a class="page-link" href="?page={{ num }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">{{ num }}</a>
                </li>
                {% endif %}
            {% endfor %}
            
            {% if page_obj.has_next %}
            <li class="page-item">
                <a class="page-link" href="?page={{ page_obj.next_page_number }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">
                    <i class="bi bi-chevron-right"></i>
                </a>
            </li>
            <li class="page-item">
                <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">
                    <i class="bi bi-chevron-double-right"></i>
                </a>
            </li>
            {% else %}
            <li class="page-item disabled">
                <span class="page-link"><i class="bi bi-chevron-right"></i></span>
            </li>
            <li class="page-item disabled">
                <span class="page-link"><i class="bi bi-chevron-double-right"></i></span>
            </li>
            {% endif %}
        </ul>
    </nav>
    {% endif %}
</div>

<!-- Jobs Grid View (Hidden by default) -->
<div id="gridView" class="job-view" style="display: none;">
    <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4 mb-4">
        {% if page_obj.object_list %}
            {% for job in page_obj.object_list %}
            <div class="col" data-source="{{ job.source|default:'internal' }}">
                <div class="card h-100">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            {% if job.company.logo %}
                            <img src="{{ job.company.logo.url }}" alt="{{ job.company.name }}" 
                                class="company-logo mb-3" style="width: 50px; height: 50px; object-fit: contain;">
                            {% else %}
                            <div class="company-placeholder bg-light d-flex align-items-center justify-content-center rounded mb-3" 
                                style="width: 50px; height: 50px;">
                                <i class="bi bi-building text-muted"></i>
                            </div>
                            {% endif %}
                            
                            <div>
                                <span class="badge bg-light text-dark">
                                    {{ job.get_job_type_display }}
                                </span>
                                {% if job.posted_date|date:'Y-m-d' >= today|date:'Y-m-d' %}<span class="badge bg-success ms-1">New</span>{% endif %}
                            </div>
                        </div>
                        
                        <h5 class="card-title">
                            <a href="{% url 'jobs:job_detail' job.id %}" class="text-decoration-none">
                                {{ job.title }}
                            </a>
                        </h5>
                        <h6 class="card-subtitle mb-2 text-muted">{{ job.company.name }}</h6>
                        
                        <div class="mb-2">
                            <small class="text-muted">
                                <i class="bi bi-geo-alt me-1"></i> {{ job.location }}
                                {% if job.is_remote %}<span class="badge bg-success ms-1">Remote</span>{% endif %}
                            </small>
                        </div>
                        
                        <p class="card-text text-truncate-3">{{ job.description|striptags|truncatewords:20 }}</p>
                        
                        {% if job.salary_min %}
                        <div class="mb-2">
                            <span class="text-success">
                                TZS {{ job.salary_min|floatformat:0 }}
                                {% if job.salary_max %}
                                - {{ job.salary_max|floatformat:0 }}
                                {% endif %}
                            </span>
                        </div>
                        {% endif %}
                    </div>
                    <div class="card-footer bg-transparent">
                        <div class="d-flex justify-content-between align-items-center">
                            <small class="text-muted">{{ job.posted_date|timesince }} ago</small>
                            <div>
                                {% if user.is_authenticated %}
                                <button class="btn btn-sm btn-outline-secondary toggle-saved-job" 
                                    data-job-id="{{ job.id }}" data-csrf="{{ csrf_token }}">
                                    <i class="bi {% if job.is_saved %}bi-bookmark-fill{% else %}bi-bookmark{% endif %}"></i>
                                </button>
                                {% endif %}
                                <a href="{% url 'jobs:job_detail' job.id %}" class="btn btn-sm btn-primary ms-1">View</a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        {% else %}
            <div class="col-12">
                <div class="p-5 text-center">
                    <div class="mb-4">
                        <i class="bi bi-search fs-1 text-muted"></i>
                    </div>
                    <h4>No jobs found</h4>
                    <p class="text-muted mb-4">We couldn't find any jobs matching your search criteria. Try adjusting your filters or search terms.</p>
                    <a href="{% url 'jobs:job_list' %}" class="btn btn-primary">View All Jobs</a>
                </div>
            </div>
        {% endif %}
    </div>
    
    <!-- Pagination (Grid View) -->
    {% if is_paginated %}
    <nav aria-label="Job pagination">
        <ul class="pagination justify-content-center">
            {% if page_obj.has_previous %}
            <li class="page-item">
                <a class="page-link" href="?page=1{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">
                    <i class="bi bi-chevron-double-left"></i>
                </a>
            </li>
            <li class="page-item">
                <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">
                    <i class="bi bi-chevron-left"></i>
                </a>
            </li>
            {% else %}
            <li class="page-item disabled">
                <span class="page-link"><i class="bi bi-chevron-double-left"></i></span>
            </li>
            <li class="page-item disabled">
                <span class="page-link"><i class="bi bi-chevron-left"></i></span>
            </li>
            {% endif %}
            
            {% for num in paginator.page_range %}
                {% if page_obj.number == num %}
                <li class="page-item active"><span class="page-link">{{ num }}</span></li>
                {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                <li class="page-item">
                    <a class="page-link" href="?page={{ num }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">{{ num }}</a>
                </li>
                {% endif %}
            {% endfor %}
            
            {% if page_obj.has_next %}
            <li class="page-item">
                <a class="page-link" href="?page={{ page_obj.next_page_number }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">
                    <i class="bi bi-chevron-right"></i>
                </a>
            </li>
            <li class="page-item">
                <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">
                    <i class="bi bi-chevron-double-right"></i>
                </a>
            </li>
            {% else %}
            <li class="page-item disabled">
                <span class="page-link"><i class="bi bi-chevron-right"></i></span>
            </li>
            <li class="page-item disabled">
                <span class="page-link"><i class="bi bi-chevron-double-right"></i></span>
            </li>
            {% endif %}
        </ul>
    </nav>
    {% endif %}
</div>

<!-- Job Alert Box -->
{% if user.is_authenticated %}
<div class="card mb-4">
    <div class="card-body text-center p-4">
        <div class="mb-3">
            <i class="bi bi-bell fs-1 text-primary"></i>
        </div>
        <h4>Get job alerts for "{{ search_form.keywords.value|default:'your preferred jobs' }}"</h4>
        <p class="text-muted">Receive new matching jobs directly in your inbox</p>
        <a href="{% url 'jobs:job_preferences' %}?keywords={{ search_form.keywords.value|default:'' }}" class="btn btn-primary">
            Create Job Alert
        </a>
    </div>
</div>
{% endif %}

{% endblock %}

{% block extra_js %}
{{ block.super }}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // List/Grid View Toggle
        const listViewBtn = document.getElementById('listViewBtn');
        const gridViewBtn = document.getElementById('gridViewBtn');
        const listView = document.getElementById('listView');
        const gridView = document.getElementById('gridView');
        
        listViewBtn.addEventListener('click', function() {
            listView.style.display = 'block';
            gridView.style.display = 'none';
            listViewBtn.classList.add('active');
            gridViewBtn.classList.remove('active');
            localStorage.setItem('jobViewPreference', 'list');
        });
        
        gridViewBtn.addEventListener('click', function() {
            listView.style.display = 'none';
            gridView.style.display = 'block';
            gridViewBtn.classList.add('active');
            listViewBtn.classList.remove('active');
            localStorage.setItem('jobViewPreference', 'grid');
        });
        
        // Load user preference if set
        const viewPreference = localStorage.getItem('jobViewPreference');
        if (viewPreference === 'grid') {
            gridViewBtn.click();
        }
        
        // Toggle saved job functionality
        const saveButtons = document.querySelectorAll('.toggle-saved-job');
        if (saveButtons.length > 0) {
            saveButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const jobId = this.getAttribute('data-job-id');
                    const csrf = this.getAttribute('data-csrf');
                    
                    fetch(`/jobs/job/${jobId}/save/`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': csrf
                        }
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            // Update all instances of the save button for this job
                            document.querySelectorAll(`.toggle-saved-job[data-job-id="${jobId}"]`).forEach(btn => {
                                const icon = btn.querySelector('i');
                                if (data.created) {
                                    icon.classList.remove('bi-bookmark');
                                    icon.classList.add('bi-bookmark-fill');
                                    btn.classList.remove('btn-outline-secondary');
                                    btn.classList.add('btn-outline-danger');
                                } else {
                                    icon.classList.remove('bi-bookmark-fill');
                                    icon.classList.add('bi-bookmark');
                                    btn.classList.remove('btn-outline-danger');
                                    btn.classList.add('btn-outline-secondary');
                                }
                            });
                        }
                    })
                    .catch(error => console.error('Error:', error));
                });
            });
        }
        
        // Job source filtering
        const sourceCheckboxes = document.querySelectorAll('[id^="source_"]');
        if (sourceCheckboxes.length > 0) {
            sourceCheckboxes.forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    filterJobsBySource();
                });
            });
            
            function filterJobsBySource() {
                const selectedSources = Array.from(sourceCheckboxes)
                    .filter(cb => cb.checked)
                    .map(cb => cb.id.replace('source_', ''));
                
                document.querySelectorAll('[data-source]').forEach(item => {
                    const source = item.getAttribute('data-source');
                    
                    if (selectedSources.includes(source)) {
                        item.classList.remove('d-none');
                    } else {
                        item.classList.add('d-none');
                    }
                });
            }
        }
    });
</script>
{% endblock %}
