{% extends 'app/base.html' %}
{% load static %}
{% load product_filters %}
{% block title %}{{ product.title }}{% endblock title %}

{% block extra_head %}
<!-- Product Description Styling -->
<style>
  .product-description {
    margin-bottom: 1.5rem;
    line-height: 1.6;
  }
  .product-description p {
    margin-bottom: 1rem;
  }
  .product-description strong,
  .product-description em,
  .product-description b,
  .product-description i {
    display: inline-block;
  }
  .product-description img {
    max-width: 100%;
    height: auto;
    margin: 1rem 0;
  }
  .product-description ul,
  .product-description ol {
    padding-left: 2rem;
    margin-bottom: 1rem;
  }
  .product-actions {
    display: flex;
    gap: 0.5rem;
  }
</style>
<!-- SEO Meta Tags -->
<meta name="description" content="{{ product.description|process_product_description|striptags|truncatechars:160 }}">
<meta name="keywords" content="{{ product.title }}, ChuoSmart, product, {{ customer.university }}, {{ customer.college }}">

<!-- Open Graph Meta Tags for better social media sharing -->
<meta property="og:title" content="{{ product.title }} | ChuoSmart">
<meta property="og:description" content="{{ product.description|process_product_description|striptags|truncatechars:200 }}">
<meta property="og:image" content="{{ request.scheme }}://{{ request.get_host }}{{ product.image.url }}">
<meta property="og:url" content="{{ request.scheme }}://{{ request.get_host }}{% url 'product-detail' slug=product.slug %}">
<meta property="og:type" content="product">
<meta property="og:site_name" content="ChuoSmart">

<!-- Twitter Card data -->
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:title" content="{{ product.title }}">
<meta property="twitter:description" content="{{ product.description|process_product_description|striptags|truncatechars:200 }}">
<meta name="twitter:image" content="{{ request.scheme }}://{{ request.get_host }}{{ product.image.url }}">
{% endblock extra_head %}

{% block main-content %}
<div class="container my-5">
  <div class="row">
    <div class="col-md-6 text-center align-self-center">
      {% load image_tags %}
      <!-- Use picture tag with WebP and fallback support -->
      {% picture webp_src=product.image_webp|safe_url fallback_src=product.image.url alt=product.title css_class="img-fluid img-thumbnail" lazy=False %}
    </div>
    <div class="col-md-6">
      <div class="d-flex justify-content-between align-items-start">
        <h1>{{ product.title }}</h1>
        {% if user.is_authenticated and product.user == user %}
          <div class="product-actions">
            <a href="{% url 'edit-product' slug=product.slug %}" class="btn btn-primary btn-sm">
              <i class="fas fa-edit"></i> Edit
            </a>
            <a href="{% url 'delete-product' slug=product.slug %}" class="btn btn-danger btn-sm">
              <i class="fas fa-trash"></i> Delete
            </a>
          </div>
          {% include 'promotions/promote_button.html' with product=product %}
        {% endif %}
      </div>
      <div class="product-description">
        {{ product.description|process_product_description|safe }}
      </div>
      <p><i class="fas fa-tag"></i> <strong>Price:</strong> TSh {{ product.price }}</p>
      <p><i class="fas fa-user"></i> <strong>Posted by:</strong> {{ customer.name }}</p>
      <p><i class="fas fa-university"></i> <strong>University:</strong> {{ customer.university }}</p>
      <p><i class="fas fa-school"></i> <strong>College:</strong> {{ customer.college }}</p>
      <p><i class="fas fa-building"></i> <strong>Block:</strong> {{ customer.block_number }}</p>
      <p><i class="fas fa-door-open"></i> <strong>Room Number:</strong> {{ customer.room_number }}</p>
      <p>
        <i class="fas fa-star" 
           style="color: 
             {% if customer.subscription == 'Bronze' %}#cd7f32
             {% elif customer.subscription == 'Silver' %}#c0c0c0
             {% elif customer.subscription == 'Gold' %}#ffd700
             {% endif %};">
        </i> 
        <strong>Seller Level:</strong> {{ customer.subscription }}
      </p>
      <p><i class="fas fa-phone"></i> <strong>Phone Number:</strong> {{ customer.phone_number }}</p>
      <hr>
      <h4>TSh {{ product.price }} <small class="fw-light text-decoration-line-through">{{ product.discount_price }}</small></h4>
      {% if user.is_authenticated %}
        {% if product_cart %}
          <a href="{% url "carts" %}" class="btn btn-primary shadow px-5 py-2">View Cart</a>
        {% else %}
          <form action="/add-to-cart" class="d-inline">
            <input type="hidden" name="product_id" value="{{ product.id }}" id="product_id">
            <button type="submit" class="btn btn-primary shadow px-5 py-2">Add to Cart</button>
          </form>
        {% endif %}
      {% else %}
        <form action="/add-to-cart" class="d-inline">
          <input type="hidden" name="product_id" value="{{ product.id }}" id="product_id">
          <button type="submit" class="btn btn-primary shadow px-5 py-2">Add to Cart</button>
        </form>
      {% endif %}
      <form action="https://wa.me/{{ customer.phone_number }}" method="get" target="_blank" class="d-inline">
        <input type="hidden" name="text" value="Hello, I am interested in your product '{{ product.title }}' listed at TSh {{ product.price }}. Please let me know if it is still available.\nListed at chuosmart.com">
        <button type="submit" class="btn btn-danger shadow px-5 py-2">Buy Now</button>
      </form>
      <h5 class="mt-5">Available Offers</h5>
      <ul>
        <li>No shipping cost if you are at the University of Dodoma</li>
        <li>5% discount if you buy more than 10 at once</li>
      </ul>
    </div>
  </div>
</div>

<!-- Related Products Section -->
{% if related_products %}
<div class="container my-5">
  <div class="text-center mb-4">
    <h2 class="fw-bold">Related Products</h2>
    <p class="text-muted">Products you might also like</p>
  </div>
  
  <div class="row g-4">
    {% for related_product in related_products %}
    <div class="col-6 col-md-4 col-lg-2">
      <a href="{% url 'product-detail' slug=related_product.slug %}" class="text-decoration-none">
        <div class="card h-100 shadow-sm related-product-card">
          {% load image_tags %}
          <div class="related-product-image-wrapper">
            {% picture webp_src=related_product.image_webp|safe_url fallback_src=related_product.image.url alt=related_product.title css_class="card-img-top related-product-image" lazy=True %}
          </div>
          <div class="card-body d-flex flex-column">
            <h6 class="card-title text-dark">{{ related_product.title|truncatewords:3 }}</h6>
            <p class="card-text text-primary fw-bold mb-2">TSh {{ related_product.price }}</p>
            <p class="card-text text-muted small mb-2">
              <i class="fas fa-map-marker-alt"></i> {{ related_product.user.customer.university|truncatewords:2 }}
            </p>
            {% if related_product.category == product.category %}
              <span class="badge bg-success mt-auto">Same Category</span>
            {% elif related_product.user == product.user %}
              <span class="badge bg-info mt-auto">Same Seller</span>
            {% endif %}
          </div>
        </div>
      </a>
    </div>
    {% endfor %}
  </div>
</div>
{% endif %}

<style>
  /* Related Products Styling */
  .related-product-card {
    transition: transform 0.3s ease, box-shadow 0.3s ease;
    border-radius: 10px;
    overflow: hidden;
  }
  
  .related-product-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 20px rgba(0, 0, 0, 0.15) !important;
  }
  
  .related-product-image-wrapper {
    height: 180px;
    overflow: hidden;
    background: #f8f9fa;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  
  .related-product-image {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }
  
  .related-product-card .card-body {
    min-height: 140px;
  }
  
  .related-product-card .card-title {
    font-size: 0.95rem;
    font-weight: 600;
    margin-bottom: 0.5rem;
    height: 2.8em;
    overflow: hidden;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
  }
  
  @media (max-width: 768px) {
    .related-product-image-wrapper {
      height: 150px;
    }
  }
</style>
{% endblock main-content %}
